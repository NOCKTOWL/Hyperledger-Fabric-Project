<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="./styles.css">

    <title>Property Tracker</title>
</head>
<body>
    <div class="text-center">
        <h1>
            Property Tracker
        </h1>
        <button onclick="getAll()">Show All Properties</button>
        <span>||</span>
        <input id="search-input" type="text">
        <button onclick="search()">Search</button>
        <div id="show-car"></div>
    </div>

    <div class="text-center form-container">
        <h3>ADD PROPERTY</h3>
        <form id="createForm" action="" name="createCar">
            <div>
                <label for="">Unique ID</label>
                <input name="key" />
            </div>
            <div>
                <label for="">Property Type</label>
                <input name="type" />
            </div>
            
            <div>
                <label for="">Property Size</label>
                <input name="make" />
            </div>

            <div>
                <label for="">Address</label>
                <input name="model" />
            </div>

            <div>
                <label for="">City</label>
                <input name="color" />
            </div>

            <div>
                <label for="">Owner Name</label>
                <input name="owner" />
            </div>

            <div>
                <button type="submit">Create</button>
            </div>
        </form>
    </div>

    <div class="text-center form-container">
        <h3 >Update Owner</h3>
        <form id="updateForm" action="" name="updateOwner">
            <div>
                <label for="">Unique ID</label>
                <input name="key" />
            </div>
            <div>
                <label for="">Property Type</label>
                <input name="type" />
            </div>
            
            <div>
                <label for="">Property Size</label>
                <input name="make" />
            </div>

            <div>
                <label for="">Address</label>
                <input name="model" />
            </div>

            <div>
                <label for="">City</label>
                <input name="color" />
            </div>
            
            <div>
                <label for="">New Owner</label>
                <input name="owner" />
            </div>

            <div>
                <button type="submit">Update</button>
            </div>
        </form>
    </div>
    
    <script>

        // CREATING NEW CAR
        const createForm = document.getElementById('createForm')

        // THIS IS AN EVENT LISTENER WHICH WILL RUN WHEN WE CLICK THE CREATE BUTTON
        createForm.addEventListener("submit", function(event) {
            event.preventDefault()
            const bodyParam = new URLSearchParams( new FormData(createForm) )
            
                //CALLING CREATE API
                fetch('http://localhost:3000/create', {
                    method: 'POST',
                    body: bodyParam
                })
                .then(res => {
                    return res.json()
                })
                .then( parsedRes => {
                    alert(parsedRes.message)
                })
                .catch(err => {
                    console.error({ err })
                })
        });

        // UPDATE: CHANGING CAR OWNER
        const updateForm = document.getElementById('updateForm')

        // THIS IS AN EVENT LISTENER WHICH WILL RUN WHEN WE CLICK THE UPDATE BUTTON
        updateForm.addEventListener("submit", function(event) {
            event.preventDefault()
            const bodyParam = new URLSearchParams( new FormData(updateForm) )
            
                //CALLING UPDATE API
                fetch('http://localhost:3000/update', {
                    method: 'POST',
                    body: bodyParam
                })
                .then(res => {
                    if(res.status !== 200){
                        alert('Unable to update')
                        return
                    }
                    return res.json()
                })
                .then( parsedRes => {
                    alert( parsedRes.message )
                    getAll()
                })
                .catch(err => {
                    alert(err.message)
                    console.error({ err })
                })
        });


        //SEARCH DATA
        function search(){
            // extracting value from input field
            const value = document.getElementById('search-input').value
            getAll( value )
        }
        
        // GETTING ALL CAR DATA FROM API
        function getAll( query ){
            const api = query ? 'http://localhost:3000/get-car?key=' + query :  'http://localhost:3000/get-car'
            fetch(api)
                .then( res => {
                    return res.json();
                })
                .then( parsedRes => {
                    let carMarkup = ''; 
                    parsedRes.forEach( item => {
                        carMarkup = carMarkup +
                            `<div class="car-item"> 
                                <p>Unique ID: ${ item.Key }</p>
                                <p>Property Type: ${ item.Record.type }</p>
                                <p>Size: ${ item.Record.make }</p>
                                <p>Address: ${ item.Record.model }</p>
                                <p>City: ${ item.Record.color }</p>
                                <p>Owner: ${ item.Record.owner }</p>
                            </div>`
                    })
                    // getting the html container with id=show-car
                    const carContainer = document.getElementById('show-car')

                    //CLEANING EXISTING CAR HTML NODE/ELEMENT
                    while (carContainer.hasChildNodes()) {
                        carContainer.removeChild(carContainer.firstChild);
                    }

                    // Adding new car data markup
                    carContainer.insertAdjacentHTML('beforeend', carMarkup)
                })
                .catch(err => {
                    alert('Operation failed')
                    console.error({ err })
                })
        }

        
    </script>
</body>
</html>